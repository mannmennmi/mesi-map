<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>百名店マップ</title>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --primary: #d32f2f;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 8px 20px rgba(0,0,0,0.15);
            --radius: 16px;
        }

        body { margin: 0; padding: 0; font-family: 'Noto Sans JP', sans-serif; overflow: hidden; background: var(--light-bg); -webkit-tap-highlight-color: transparent; }
        
        /* 全画面地図 */
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* --- 階層型フィルターUI --- */
        .ui-container {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 1000;
            background: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 60%, rgba(255,255,255,0) 100%);
            padding-bottom: 30px;
            pointer-events: none;
        }

        /* 1段目: ジャンル (親) */
        .genre-bar {
            display: flex; gap: 8px; padding: 12px 15px 8px 15px;
            overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;
            pointer-events: auto;
        }
        .genre-bar::-webkit-scrollbar { display: none; }

        .pill-btn {
            background: var(--white); border: 1px solid #e0e0e0; border-radius: 24px;
            padding: 8px 16px; font-size: 13px; font-weight: 700; color: var(--dark);
            white-space: nowrap; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; gap: 6px;
        }
        .pill-btn i { color: var(--gray); font-size: 12px; }
        .pill-btn.active { background: var(--dark); color: var(--white); border-color: var(--dark); transform: scale(1.02); }
        .pill-btn.active i { color: var(--white); }

        /* 2段目: エリア (子) */
        .area-bar {
            display: flex; gap: 6px; padding: 0 15px;
            overflow-x: auto; scrollbar-width: none;
            height: 0; opacity: 0; transition: all 0.3s ease;
            pointer-events: auto;
        }
        .area-bar.show { height: 34px; opacity: 1; padding-top: 4px; }

        .area-pill {
            background: rgba(255,255,255,0.8); border: 1px solid var(--primary);
            border-radius: 12px; padding: 4px 12px; font-size: 11px; font-weight: 700;
            color: var(--primary); white-space: nowrap; cursor: pointer; backdrop-filter: blur(4px);
        }
        .area-pill.active { background: var(--primary); color: var(--white); box-shadow: 0 2px 6px rgba(211, 47, 47, 0.3); }

        /* --- 現在地ボタン (FAB) --- */
        .fab-location {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            width: 56px; height: 56px; background: var(--white);
            border-radius: 50%; box-shadow: var(--shadow);
            border: none; cursor: pointer; font-size: 22px; color: #555;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; pointer-events: auto;
        }
        .fab-location:active { transform: scale(0.9); }
        .fab-location.loading i { animation: spin 1s linear infinite; }

        /* --- カード型ポップアップ (リッチデザイン) --- */
        .leaflet-popup-content-wrapper { padding: 0; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
        .leaflet-popup-content { margin: 0 !important; width: 280px !important; }
        .leaflet-container a.leaflet-popup-close-button {
            top: 8px; right: 8px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            font-size: 20px; padding: 0; width: 24px; height: 24px;
        }
        
        .card-img {
            width: 100%; height: 160px;
            background-color: #eee; background-size: cover; background-position: center;
            position: relative;
        }
        /* 画像上のグラデーション（文字を見やすく） */
        .card-img::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
        }
        
        .card-tag { 
            position: absolute; bottom: 10px; left: 15px; z-index: 2;
            color: white; font-size: 11px; font-weight: bold; letter-spacing: 0.05em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .card-body { padding: 16px; background: white; }
        
        .card-title { 
            font-size: 17px; font-weight: 700; margin: 0 0 8px 0; 
            color: var(--dark); line-height: 1.4; 
        }
        
        .card-meta { 
            display: flex; align-items: center; gap: 12px; margin-bottom: 10px; 
            border-bottom: 1px solid #f0f0f0; padding-bottom: 10px;
        }
        
        .card-rating { 
            display: flex; align-items: center; gap: 4px; 
            color: #f39c12; font-weight: 700; font-size: 18px; 
        }
        .card-rating small { font-size: 11px; color: var(--gray); font-weight: normal; margin-left: 2px; }

        .card-address {
            font-size: 11px; color: var(--gray); display: flex; align-items: center; gap: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;
        }

        /* 予算表示エリア */
        .card-budget {
            display: flex; gap: 15px; font-size: 12px; color: #666; margin-bottom: 15px;
        }
        .budget-item { display: flex; align-items: center; gap: 5px; }
        .budget-item i { width: 14px; text-align: center; }
        .budget-dinner i { color: #5e35b1; } /* 夜っぽい色 */
        .budget-lunch i { color: #fbc02d; }  /* 昼っぽい色 */

        .card-btn {
            display: block; text-align: center; background: var(--primary); color: var(--white);
            text-decoration: none; padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 700;
            transition: opacity 0.2s;
        }
        .card-btn:hover { opacity: 0.9; }

        /* 現在地マーカー */
        .user-marker {
            width: 20px; height: 20px; background: #4285F4;
            border: 3px solid white; border-radius: 50%;
            box-shadow: 0 0 8px rgba(66,133,244,0.6);
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* ローディング画面 */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--white); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s;
        }
        .loader-spinner {
            width: 40px; height: 40px; border: 4px solid #eee;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <!-- ロード画面 -->
    <div id="loader">
        <div class="loader-spinner"></div>
        <p style="font-weight:700; color:#555; font-size:14px;">百名店マップを読み込み中...</p>
    </div>

    <!-- 階層型フィルター -->
    <div class="ui-container">
        <!-- 親カテゴリ (ラーメン, カレー...) -->
        <div class="genre-bar" id="genre-container"></div>
        <!-- 子エリア (TOKYO, WEST...) -->
        <div class="area-bar" id="area-container"></div>
    </div>

    <!-- FAB: 現在地 -->
    <button class="fab-location" id="btn-location" onclick="getMyLocation()">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <!-- 地図 -->
    <div id="map"></div>

    <!-- スクリプト -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 初期設定 ---
        const map = L.map('map', { zoomControl: false }).setView([35.6812, 139.7671], 12);
        
        // 地図スタイル：CartoDB Voyager (シンプルで美しい)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 20
        }).addTo(map);

        let allShops = [];
        let markers = [];
        let userMarker = null;
        let categoryMap = {}; 
        let activeCategory = 'ラーメン';
        let activeArea = null;

        // --- 1. データ読み込み ---
        async function initApp() {
            try {
                // キャッシュ対策のためにタイムスタンプを付与
                const response = await fetch('./shops_final.json?' + new Date().getTime());
                if (!response.ok) throw new Error("JSONが見つかりません");
                allShops = await response.json();
                
                processCategories(); // カテゴリ解析
                initUI();            // UI構築
                
                // 現在地を取得して地図の中心を設定
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const { latitude, longitude } = pos.coords;
                            
                            // 現在地マーカーを表示
                            const icon = L.divIcon({ className: 'user-marker', iconSize: [20,20] });
                            userMarker = L.marker([latitude, longitude], { icon: icon }).addTo(map);
                            
                            // 地図の中心を現在地に設定（ズームレベル15で周辺を表示）
                            map.setView([latitude, longitude], 15);
                            
                            updateMap(); // 地図描画
                            
                            // ローディング終了
                            setTimeout(() => {
                                document.getElementById('loader').style.opacity = '0';
                                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                            }, 500);
                        },
                        (err) => {
                            console.warn("位置情報の取得に失敗しました。デフォルト位置を表示します。", err);
                            // エラー時はデフォルト位置（東京）を表示
                            map.setView([35.6812, 139.7671], 12);
                            updateMap(); // 地図描画
                            
                            // ローディング終了
                            setTimeout(() => {
                                document.getElementById('loader').style.opacity = '0';
                                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                            }, 500);
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                } else {
                    // 位置情報がサポートされていない場合はデフォルト位置を表示
                    map.setView([35.6812, 139.7671], 12);
                    updateMap(); // 地図描画
                    
                    // ローディング終了
                    setTimeout(() => {
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                    }, 500);
                }

            } catch (e) {
                console.error(e);
                alert("データの読み込みに失敗しました。\nローカルサーバーが起動しているか確認してください。");
            }
        }

        // --- 2. カテゴリ階層化ロジック ---
        // "ラーメンTOKYO" -> 親:ラーメン, 子:TOKYO
        // "ハンバーガー" -> 親:ハンバーガー, 子:なし
        function processCategories() {
            const areaKeywords = ["TOKYO", "OSAKA", "EAST", "WEST", "HOKKAIDO", "KANAGAWA", "AICHI", "FUKUOKA", "KAGAWA"];
            categoryMap = { 'すべて': [] };

            allShops.forEach(shop => {
                let rawGenre = shop.genre;
                let parent = rawGenre;
                let child = null;

                // エリアキーワードで終わるかチェック
                for (const area of areaKeywords) {
                    if (rawGenre.endsWith(area)) {
                        parent = rawGenre.replace(area, ""); 
                        child = area;
                        break;
                    }
                }

                if (!categoryMap[parent]) categoryMap[parent] = [];
                if (child && !categoryMap[parent].includes(child)) {
                    categoryMap[parent].push(child);
                }

                // データ拡張
                shop._parentGenre = parent;
                shop._childArea = child;
            });
        }

        // --- 3. UI生成 (親ジャンル) ---
        function initUI() {
            const container = document.getElementById('genre-container');
            const parents = Object.keys(categoryMap);

            // よく使うアイコンのマッピング
            const iconMap = {
                'ラーメン': 'fa-bowl-food', 'カレー': 'fa-pepper-hot', 'パン': 'fa-bread-slice',
                'スイーツ': 'fa-ice-cream', 'カフェ': 'fa-mug-hot', '焼肉': 'fa-fire',
                '寿司': 'fa-fish', 'イタリアン': 'fa-pizza-slice', 'ハンバーガー': 'fa-burger',
                'すべて': 'fa-utensils'
            };

            parents.forEach(parent => {
                const btn = document.createElement('button');
                btn.className = `pill-btn ${parent === activeCategory ? 'active' : ''}`;
                
                const iconClass = iconMap[parent] || 'fa-utensils';
                btn.innerHTML = `<i class="fa-solid ${iconClass}"></i> ${parent}`;
                
                btn.onclick = () => {
                    document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    activeCategory = parent;
                    activeArea = null; 
                    renderAreaButtons(parent);
                    updateMap();
                };
                container.appendChild(btn);
            });
            
            // 初期状態でラーメンのエリアボタンを表示
            renderAreaButtons(activeCategory);
        }

        // --- 4. UI生成 (子エリア) ---
        function renderAreaButtons(parentGenre) {
            const container = document.getElementById('area-container');
            container.innerHTML = '';
            const areas = categoryMap[parentGenre] || [];

            // エリアがある場合のみ表示
            if (areas.length > 0) {
                container.classList.add('show');
                
                const allBtn = document.createElement('button');
                allBtn.className = 'area-pill active';
                allBtn.innerText = '全エリア';
                allBtn.onclick = () => handleAreaClick(allBtn, null);
                container.appendChild(allBtn);

                areas.forEach(area => {
                    const btn = document.createElement('button');
                    btn.className = 'area-pill';
                    btn.innerText = area;
                    btn.onclick = () => handleAreaClick(btn, area);
                    container.appendChild(btn);
                });
            } else {
                container.classList.remove('show');
            }
        }

        function handleAreaClick(btn, area) {
            document.querySelectorAll('.area-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeArea = area;
            updateMap();
        }

        // --- 5. 地図更新とポップアップ生成 ---
        function updateMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const filtered = allShops.filter(shop => {
                if (activeCategory !== 'すべて' && shop._parentGenre !== activeCategory) return false;
                if (activeArea && shop._childArea !== activeArea) return false;
                return true;
            });

            filtered.forEach(shop => {
                if (!shop.lat || !shop.lng) return;

                const imgUrl = shop.image_url ? shop.image_url : 'https://via.placeholder.com/300x200?text=No+Image';
                const rating = shop.rating > 0 ? shop.rating.toFixed(2) : '-';
                
                // 予算情報の整形 (データがない場合は '-')
                const dinner = shop.budget_dinner || '-';
                const lunch = shop.budget_lunch || '-';

                const popupContent = `
                    <div class="card-img" style="background-image: url('${imgUrl}');">
                        <div class="card-tag">${shop.genre}</div>
                    </div>
                    <div class="card-body">
                        <div class="card-title">${shop.name}</div>
                        
                        <div class="card-meta">
                            <div class="card-rating">
                                <i class="fa-solid fa-star"></i> ${rating}
                                <small>点</small>
                            </div>
                            <div class="card-address">
                                <i class="fa-solid fa-location-dot"></i> ${shop.address || '住所不明'}
                            </div>
                        </div>

                        <div class="card-budget">
                            <div class="budget-item budget-dinner">
                                <i class="fa-solid fa-moon"></i> ${dinner}
                            </div>
                            <div class="budget-item budget-lunch">
                                <i class="fa-solid fa-sun"></i> ${lunch}
                            </div>
                        </div>

                        <a href="${shop.url}" target="_blank" class="card-btn">
                            食べログで詳細を見る <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    </div>
                `;

                // マーカー作成
                const marker = L.marker([shop.lat, shop.lng])
                    .bindPopup(popupContent, { maxWidth: 280, minWidth: 280, closeButton: true });
                
                marker.addTo(map);
                markers.push(marker);
            });
        }

        // --- 6. 現在地機能 ---
        function getMyLocation() {
            const btn = document.getElementById('btn-location');
            if (!navigator.geolocation) return alert("お使いの端末は位置情報をサポートしていません");

            btn.classList.add('loading');

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    
                    if (userMarker) map.removeLayer(userMarker);
                    
                    const icon = L.divIcon({ className: 'user-marker', iconSize: [20,20] });
                    userMarker = L.marker([latitude, longitude], { icon: icon }).addTo(map);
                    
                    // ズームして移動
                    map.flyTo([latitude, longitude], 15, { animate: true, duration: 1.5 });
                    btn.classList.remove('loading');
                },
                (err) => {
                    console.warn(err);
                    alert("位置情報を取得できませんでした。\n・ブラウザの位置情報許可を確認してください\n・https接続でないと動作しない場合があります");
                    btn.classList.remove('loading');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        initApp();
    </script>
</body>
</html>